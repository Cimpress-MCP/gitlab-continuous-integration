#Used for extending build with this for services that use a databases. 

#Using this will require deploycomponents.yaml  
.buildDatabaseWithNpm:
  image: kevinrambaud/node-flyway:8-5.1.4-alpine
  stage: build  
  script:
    - cp -r $CI_PROJECT_DIR/sql/* /flyway/sql/
    - sh /flyway/flyway -url=jdbc:postgresql://$POSTGRES_SERVER:5432/$POSTGRES_DB -schemas=public -user=$POSTGRES_USER -password=$POSTGRES_PASSWORD -placeholders.ENVIRONMENT=$DEPLOYENV migrate
    - npm test
  coverage: '/All files\s*\|\s*[.?\d]+\s*\|\s*([0-9.]+)/'
  artifacts:
    paths:
      - coverage/
  services:
    - $POSTGRES_VERSION  